{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %}

<!-- {% block stylesheets %}{% endblock stylesheets %} -->

{% block content %}

<main class="content">

    {% include 'includes/navigation.html' %}

    <div class="col-12 text-xl-center mb-4 py-4 mb-xl-0">
        <!-- <div id="progress"></div> -->
    </div>

    <div class="main-container">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-10 py-2">
                <div class="card h-100 card-body bg-white border-dark shadow-sm text-center p-0">

                    <div class="card-body pb-5">
                        <div class="row">

                            <div class="col-12 col-xl-3">
                                <!-- <h1>Spacer</h1> -->
                            </div>

                            <div class="col-12 col-xl-6 mb-4">
                                <div
                                    class="col-12 col-xl-12 text-xl-center mb-3 mb-xl-0 d-flex justify-content-xl-center">
                                    <div class="icon-shape d-flex icon-shape-white rounded">
                                        <span>
                                            <i class="text-white {{ weather_icon }}"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-12 col-xl-12 px-xl-0">
                                    <div class="d-none d-sm-block"></div>
                                    <h1 class="mb-1 text-white">{{ weather.detailed_status|title }}</h1>
                                    <li role="separator" class="dropdown-divider mb-4 border-gold"></li>
                                </div>

                                <div class="col-12 col-xl-12 px-xl-0">
                                    <h4 class="h6 text-white">
                                        {{ current_date.strftime('%A %d %b, %H:%M') }}
                                    </h4>
                                    <h4 class="h6 mt-2 text-white">
                                        <span class="fas fa-globe-europe text-white"></span>
                                        {{ current_user.city }}
                                    </h4>
                                </div>
                                <div class="d-flex justify-content-center ml-xl-3 py-5">
                                    <div class="d-md-block">
                                        <div class="btn-group mr-2 mb-2 py-2">
                                            <button type="button" id="start-bg-job" class="btn btn-light">
                                                Water Plants
                                            </button>
                                            <button type="button"
                                                class="btn btn-light dropdown-toggle dropdown-toggle-split"
                                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <span class="fas fa-angle-down dropdown-arrow"></span>
                                                <span class="sr-only">Toggle Dropdown</span>
                                            </button>
                                            <div class="dropdown-menu">
                                                <a class="dropdown-item" href="#">5 Minute Water</a>
                                                <a class="dropdown-item" href="#">10 Minute Water</a>
                                                <a class="dropdown-item" href="#">30 Minute Water</a>
                                                <div class="dropdown-divider"></div>
                                                <a class="dropdown-item" href="#">Stop Watering</a>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-xl-3">
                                <!-- <h1>Spacer</h1> -->
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 text-xl-center mb-4 py-4 mb-xl-0">
                                <span id="progress"></span>
                                <span id="progressbar"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 col-xl-3">
                                <div class="d-flex align-items-end flex-column mt-auto">
                                    <div class="col-12 col-xl-12 px-xl-0">
                                        <div class="d-none d-sm-block"></div>
                                        <h5 class="mb-1 text-white">Last Rained</h5>
                                        <li role="separator" class="dropdown-divider mb-4 border-gold"></li>
                                    </div>

                                    <div class="col-12 col-xl-12 px-xl-0">
                                        <h4 class="h6 text-white">
                                            {{ current_date.strftime('%A %d %b') }}
                                        </h4>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-xl-3">
                                <div class="d-flex align-items-end flex-column mt-auto">
                                    <div class="col-12 col-xl-12 px-xl-0">
                                        <div class="d-none d-sm-block"></div>
                                        <h5 class="mb-1 text-white">Last Watered</h5>
                                        <li role="separator" class="dropdown-divider mb-4 border-gold"></li>
                                    </div>

                                    <div class="col-12 col-xl-12 px-xl-0">
                                        <h4 class="h6 text-white">
                                            {{ current_date.strftime('%A %d %b') }}
                                        </h4>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-xl-3">
                                <div class="d-flex align-items-end flex-column mt-auto">
                                    <div class="col-12 col-xl-12 px-xl-0">
                                        <div class="d-none d-sm-block"></div>
                                        <h5 class="mb-1 text-white">Next Rain</h5>
                                        <li role="separator" class="dropdown-divider mb-4 border-gold"></li>
                                    </div>

                                    <div class="col-12 col-xl-12 px-xl-0">
                                        <h4 class="h6 text-white">
                                            {{ current_date.strftime('%A %d %b') }}
                                        </h4>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-xl-3">
                                <div class="d-flex align-items-end flex-column mt-auto">
                                    <div class="col-12 col-xl-12 px-xl-0">
                                        <div class="d-none d-sm-block"></div>
                                        <h5 class="mb-1 text-white">Next Water</h5>
                                        <li role="separator" class="dropdown-divider mb-4 border-gold"></li>
                                    </div>

                                    <div class="col-12 col-xl-12 px-xl-0">
                                        <h4 class="h6 text-white">
                                            {{ current_date.strftime('%A %d %b') }}
                                        </h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script src="/static/assets/js/jquery.min.js"></script>
            <script src="/static/assets/js/progressbar.min.js"></script>
            <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.min.js"></script>
            <script>

                var bar = new ProgressBar.Line('#progressbar', {
                    strokeWidth: 0.2,
                    easing: 'easeInOut',
                    duration: 1400,
                    color: '#e9b25d',
                    trailColor: '#eee',
                    trailWidth: 1,
                    text: {
                        style: {
                            // Text color.
                            // Default: same as stroke color (options.color)
                            color: '#999',
                            position: 'absolute',
                            right: '0',
                            top: '30px',
                            padding: 0,
                            margin: 0,
                            transform: null
                        },
                        autoStyleContainer: false
                    },
                    from: { color: '#e9b25d' },
                    to: { color: '#e9b25d' },
                    step: (state, bar) => {
                        bar.setText(Math.round(bar.value() * 100) + ' %');
                    }
                });

                function emit_water_plants() {

                    namespace = '/test';
                    var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
                    socket.emit('shorttask')
                    display_water_progress()
                }

                function display_water_progress() {

                    div = $('<div id="displayWaterProgress" class="progress rounded">\
                        <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" style="min-width: 20px;"></div>\
                    </div>');

                    var element = document.getElementById('displayWaterProgress');

                    if (element == null) {
                        $('#progress').append(div);

                        document.getElementById("start-bg-job").disabled = true;
                        document.getElementById("waterStatusIcon").classList.remove('fa-tint-slash');
                        document.getElementById("waterStatusIcon").classList.add('fa-tint');
                        document.getElementById("waterStatusText").innerHTML = "System: Watering"
                    }

                    namespace = '/test';
                    var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

                    socket.on('short_response', function (reponse) {

                        var myJSON = JSON.parse(JSON.stringify(reponse));
                        update_line_progress(myJSON, div[0], bar);

                    });
                }

                function update_line_progress(myJSON, status_div, bar) {

                    percent = parseInt(myJSON['current'] * 100 / parseInt(myJSON['total']));
                    $(".progress-bar").css("width", percent + "%").text(percent + " %");
                    bar.animate(percent / 100)

                    $(status_div.childNodes[1]).text("Watering: " + percent + '%');

                    if (myJSON['status'] == 'Done') {

                        $(status_div.childNodes[1]).text("Completed");
                        setTimeout(function () {
                            $('#progress').empty();
                            bar.destroy();
                        }, 2500);
                        setTimeout(function () {
                            document.getElementById("start-bg-job").disabled = false;
                            document.getElementById("waterStatusIcon").classList.remove('fa-tint');
                            document.getElementById("waterStatusIcon").classList.add('fa-tint-slash');
                            document.getElementById("waterStatusText").innerHTML = "System: Idle"
                        }, 2500);

                    }
                }

                $(document).ready(function () {

                    namespace = '/test';
                    var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

                    socket.on('connect', function () {
                        socket.emit('connection', { connection_confirmation: 'Socket: Connected' });

                    });

                    socket.on('confirmation', function (data) {
                        var confir_str = data.connection_confirmation;
                        connection_status = '<span class="icon w-20 icon-xs icon-success mr-1"><span class="fas fa-plug"></span></span>' + confir_str
                        document.getElementById("socketStatusIcon").classList.remove('icon-danger');
                        document.getElementById("socketStatusIcon").classList.add('icon-success');
                        document.getElementById("socketStatusText").innerHTML = confir_str
                    });

                    socket.on('short_response', function (reponse) {

                        display_water_progress();
                    });

                    $(function () {
                        $('#start-bg-job').click(emit_water_plants);
                    });
                });

            </script>

            {% include 'includes/footer.html' %}

</main>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}