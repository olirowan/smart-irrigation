{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

<main class="content">

    {% include 'includes/navigation.html' %}

    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center py-4">
    </div>

    <div class="row justify-content-md-center">
        <div class="col-12 col-xl-10 py-2">
            <div class="card h-100 card-body bg-white border-dark shadow-sm">
                <div class="row d-block d-xl-flex align-items-center">
                    <div class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">
                        <button class="btn btn-primary mb-4" id="start-bg-job">Start Watering</button>
                    </div>
                </div>
                <div class="row ">
                    <div class="col-12 text-xl-center mb-3 mb-xl-0">
                        <div id="progress" class="mb-4"></div>
                    </div>
                </div>
                <div class="row d-block d-xl-flex align-items-center">
                    <div class="col-12 col-xl-5 text-xl-center mb-3 mb-xl-0 d-flex align-items-center justify-content-xl-center">

                        <div class="icon icon-shape icon-md icon-shape-blue rounded mr-4 mr-sm-0">
                            <span>
                                <i class="{{ weather_icon }}"></i>
                            </span>
                        </div>
  
                    </div>
                    <div class="col-12 col-xl-7 px-xl-0">
                        <div class="d-none d-sm-block">
                            <h3 class="h2 text-white">Weather</h3>
                            <h1 class="mb-1 text-white">{{ weather.detailed_status|title }}</h1>
                        </div>
                        <h4>
                            <small class="text-white">
                                {{ current_date.strftime('%a %d %b %H:%M') }}
                            </small>
                        </h4>
                        <div class="small mt-2 text-white">
                            <h4>
                            <span class="icon icon-small text-white">
                                <span class="fas fa-globe-europe text-white"></span>
                            </span>
                            {{ current_user.city }}

                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/assets/js/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.min.js"></script>
    <script>

        function emit_water_plants() {

            namespace = '/test';
            var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
            socket.emit('shorttask')
            display_water_progress()
        }

        function display_water_progress() {

            div = $('<div id="displayWaterProgress" class="progress">\
                        <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" style="min-width: 20px;"></div>\
                    </div>');

            var element = document.getElementById('displayWaterProgress');

            if (element == null) {
                $('#progress').append(div);

                document.getElementById("start-bg-job").disabled = true;
                document.getElementById("waterStatusIcon").classList.remove('fa-tint-slash');
                document.getElementById("waterStatusIcon").classList.add('fa-tint');
                document.getElementById("waterStatusText").innerHTML = "System: Watering"
            }

            namespace = '/test';
            var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

            socket.on('short_response', function (reponse) {

                var myJSON = JSON.parse(JSON.stringify(reponse));
                update_line_progress(myJSON, div[0]);

            });
        }

        function update_line_progress(myJSON, status_div) {

            percent = parseInt(myJSON['current'] * 100 / parseInt(myJSON['total']));
            $(".progress-bar").css("width", percent + "%").text(percent + " %");

            $(status_div.childNodes[1]).text("Watering: " + percent + '%');

            if (myJSON['status'] == 'Done') {

                $(status_div.childNodes[1]).text("Completed");
                setTimeout(function () {
                    $('#progress').empty();
                }, 2500);
                setTimeout(function () {
                    document.getElementById("start-bg-job").disabled = false;
                    document.getElementById("waterStatusIcon").classList.remove('fa-tint');
                    document.getElementById("waterStatusIcon").classList.add('fa-tint-slash');
                    document.getElementById("waterStatusText").innerHTML = "System: Idle"
                }, 2500);

            }
        }

        $(document).ready(function () {

            namespace = '/test';
            var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

            socket.on('connect', function () {
                socket.emit('connection', { connection_confirmation: 'Socket: Connected' });

            });

            socket.on('confirmation', function (data) {
                var confir_str = data.connection_confirmation;
                connection_status = '<span class="icon w-20 icon-xs icon-success mr-1"><span class="fas fa-plug"></span></span>' + confir_str
                document.getElementById("socketStatusIcon").classList.remove('icon-danger');
                document.getElementById("socketStatusIcon").classList.add('icon-success');
                document.getElementById("socketStatusText").innerHTML = confir_str
            });

            socket.on('short_response', function (reponse) {

                display_water_progress();
            });

            $(function () {
                $('#start-bg-job').click(emit_water_plants);
            });
        });

    </script>

    {% include 'includes/footer.html' %}

</main>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}{% endblock javascripts %}